# MQ 直立式廣告機內容管理系統 v4.7.0

**日期:** 2025年7月18日

## 🚀 新增功能

## 🛠️ 更新與改進

### 1. 後端修改 (`src/index.ts`)

- 設定更新 API 強化：
  - 在 PUT `/api/settings` 中添加了 WebSocket 廣播
  - 當設定保存成功後，發送 `settings_updated` 事件給所有連接的客戶端
- 心跳機制實現：
  - ✅ 在 `MessageBroadcaster` 中添加了心跳機制
  - ✅ 每 30 秒通過 Durable Object alarm 發送 ping 訊息
  - ✅ 處理客戶端回傳的 pong 訊息
  - ✅ 自動清理已斷線的連接

### 2. 前端修改 (`public/js/animation.js`)

- WebSocket 連接管理：
  - ✅ 添加心跳超時檢測 (65秒)
  - ✅ 收到 ping 時自動回應 pong
  - ✅ 心跳超時時主動重連
  - ✅ 改善的斷線重連機制
- 事件處理機制：
  - 添加 `settings_updated` 事件監聽
  - 收到更新通知時重新載入媒體數據和設定
  - 自動更新所有區塊

### 3. 管理介面修改 (`public/js/admin.js`)

- 心跳機制整合：
  - ✅ 實作完整心跳機制
  - ✅ 獨立的變數命名避免衝突
  - ✅ 完整的錯誤處理和重連邏輯
- 事件處理與優化：
  - 添加 `settings_updated` 事件監聽
  - 確保管理介面即時反映設定變更
- 連接穩定性提升：
  - 30 秒心跳間隔：平衡性能和連接穩定性
  - 65 秒超時檢測：允許最多錯過 2 個心跳
  - 自動重連：5 秒延遲避免頻繁重試
  - 連接清理：後端自動清理死連接
  - 錯誤處理：完整的異常處理機制

## 🐛 BUG 修復

### 1. 廣告機設定更新不會即時同步問題

**問題描述：**
- 在 `admin.html` 管理頁面更新全局播放設定（輪播秒數）後，`display.html` 展示頁面不會即時更新
- 廣告機需要手動刷新頁面才能應用新的設定
- 上傳圖片時廣告機會即時更新，但設定變更不會

**解決方案：**
- ✅ 確認後端已正確發送 `settings_updated` WebSocket 事件
- ✅ 前端正確處理 `settings_updated` 事件並重新載入數據
- ✅ 廣告機環境自動檢測和特殊處理邏輯

### 2. 廣告機瀏覽器長時間運行後自動休眠問題

**問題描述：**
- 廣告機在 Kiosk 模式下運行一段時間後會自動進入休眠狀態
- WebSocket 連接中斷，無法接收即時更新
- 需要手動重啟瀏覽器才能恢復正常

**根本原因分析：**
- Kiosk 腳本缺少防休眠參數
- Chromium 瀏覽器的背景計時器被限制
- 系統層面的螢幕保護程式啟動
- 缺少 WebSocket 心跳機制

**解決方案：**

#### A. 前端 JavaScript 防休眠機制 (`public/js/animation.js`)
- ✅ 廣告機環境自動檢測
- ✅ 每 5 分鐘自動檢查 WebSocket 連接狀態
- ✅ 頁面可見性變化時重新連接
- ✅ 焦點事件監聽和處理
- ✅ 30 分鐘無活動時自動刷新連接
- ✅ 輕微的 DOM 操作保持頁面活躍

#### B. Kiosk 腳本優化
- ✅ 系統層面防休眠設定 (`xset` 命令)
- ✅ 關鍵 Chromium 防休眠參數：
  - `--disable-background-timer-throttling` - 防止背景計時器被限制
  - `--disable-backgrounding-occluded-windows` - 防止窗口休眠
  - `--disable-renderer-backgrounding` - 防止渲染器背景模式
  - `--disable-background-media-suspend` - 防止媒體播放暫停
  - `--memory-pressure-off` - 關閉記憶體壓力管理
- ✅ 網路連接檢查和等待機制
- ✅ 瀏覽器狀態監控和自動重啟
- ✅ 臨時用戶資料目錄避免權限問題

#### C. WebSocket 心跳機制強化
- ✅ 30 秒心跳間隔，65 秒超時檢測
- ✅ 自動 ping/pong 響應機制
- ✅ 連接斷線時自動重連（5 秒延遲）
- ✅ 死連接自動清理

## 🔧 技術改進

### 1. 廣告機專用優化

**環境檢測：**
```javascript
const isRaspberryPi = /arm|aarch64/i.test(navigator.platform) || 
                     /raspberry/i.test(navigator.userAgent) ||
                     /linux.*arm/i.test(navigator.userAgent);
```

**防休眠機制：**
- 定期連接檢查（每 5 分鐘）
- 頁面可見性監控
- 焦點事件處理
- 活動監控（滑鼠移動檢測）
- 長時間無活動處理（30 分鐘後刷新）
- DOM 保活機制

### 2. Kiosk 腳本完整版

**系統防休眠：**
```bash
xset s off          # 防止螢幕保護程式
xset -dpms          # 關閉省電模式
xset s noblank      # 防止螢幕變黑
```

**瀏覽器防休眠參數：**
- 背景計時器保護
- 窗口背景化防護
- 媒體播放保護
- 記憶體管理優化
- 自動播放支援

### 3. 三重防護機制

1. **系統層面** - `xset` 命令和 DISPLAY 環境變數
2. **瀏覽器層面** - Chromium 防休眠參數集
3. **JavaScript 層面** - 前端防休眠和心跳機制

## 🧪 測試與驗證

### 測試環境
- ✅ 廣告機 Kiosk 模式長時間運行測試
- ✅ 設定更新即時同步測試
- ✅ WebSocket 心跳機制驗證
- ✅ 瀏覽器防休眠參數效果確認

### 測試工具
- 創建了非全螢幕測試模式腳本
- 提供詳細的調試指南
- 控制台日誌監控方案

## 📋 部署說明

### 廣告機 Kiosk 腳本部署
1. 複製改進版 `kiosk.sh` 腳本到廣告機
2. 設定執行權限：`chmod +x kiosk.sh`
3. 測試執行：`./kiosk.sh`
4. 確認防休眠機制正常運作

### 預期效果
- ✅ 廣告機 24/7 穩定運行不休眠
- ✅ 設定變更即時同步無需手動刷新
- ✅ WebSocket 連接持續穩定
- ✅ 媒體內容自動播放和輪播