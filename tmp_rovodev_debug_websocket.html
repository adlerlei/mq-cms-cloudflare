<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 事件調試工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.danger { background: #dc3545; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .ping { color: #28a745; font-weight: bold; }
        .pong { color: #17a2b8; font-weight: bold; }
        .settings { color: #6f42c1; font-weight: bold; }
        .playlist { color: #fd7e14; font-weight: bold; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 WebSocket 事件調試工具</h1>
        <p>此工具用於調試樹莓派 display.html 不會自動刷新的問題</p>
        
        <div class="grid">
            <div class="section">
                <h3>📡 WebSocket 狀態</h3>
                <div id="wsStatus" class="status disconnected">未連接</div>
                <button class="button" onclick="connectWS()">連接</button>
                <button class="button danger" onclick="disconnectWS()">斷開</button>
                <button class="button warning" onclick="clearLog()">清除日誌</button>
            </div>
            
            <div class="section">
                <h3>🧪 測試操作</h3>
                <button class="button success" onclick="testSettingsUpdate()">模擬設定更新</button>
                <button class="button" onclick="testPlaylistUpdate()">模擬播放列表更新</button>
                <button class="button warning" onclick="sendPing()">發送 Ping</button>
                <button class="button" onclick="fetchCurrentData()">獲取當前數據</button>
            </div>
        </div>
        
        <div class="section">
            <h3>📝 WebSocket 事件日誌</h3>
            <div id="eventLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>📊 當前數據狀態</h3>
            <div id="dataStatus" class="log">尚未載入數據</div>
        </div>
    </div>

    <script>
        let debugSocket = null;
        let logContainer = document.getElementById('eventLog');
        let dataContainer = document.getElementById('dataStatus');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logContainer.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateStatus(connected) {
            const statusEl = document.getElementById('wsStatus');
            if (connected) {
                statusEl.className = 'status connected';
                statusEl.textContent = '✅ 已連接';
            } else {
                statusEl.className = 'status disconnected';
                statusEl.textContent = '❌ 已斷線';
            }
        }
        
        function clearLog() {
            logContainer.innerHTML = '';
        }
        
        function connectWS() {
            if (debugSocket) {
                debugSocket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            log(`🔌 正在連接: ${wsUrl}`, 'info');
            debugSocket = new WebSocket(wsUrl);
            
            debugSocket.onopen = () => {
                updateStatus(true);
                log('✅ WebSocket 連接成功', 'info');
            };
            
            debugSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    let logClass = 'info';
                    let emoji = '📨';
                    
                    if (data.type === 'ping') {
                        logClass = 'ping';
                        emoji = '🏓';
                        // 自動回應 pong
                        debugSocket.send(JSON.stringify({ type: 'pong', timestamp: Date.now() }));
                        log('🏓 已自動回應 pong', 'pong');
                    } else if (data.type === 'pong') {
                        logClass = 'pong';
                        emoji = '🏓';
                    } else if (data.type === 'settings_updated') {
                        logClass = 'settings';
                        emoji = '⚙️';
                        log('🎉 這就是我們要找的事件！設定更新通知！', 'settings');
                    } else if (data.type === 'playlist_updated') {
                        logClass = 'playlist';
                        emoji = '📋';
                    }
                    
                    log(`${emoji} 收到: ${JSON.stringify(data)}`, logClass);
                } catch (error) {
                    log(`❌ 訊息解析失敗: ${error.message}`, 'error');
                }
            };
            
            debugSocket.onclose = (event) => {
                updateStatus(false);
                log(`❌ 連接關閉: ${event.code} - ${event.reason}`, 'error');
            };
            
            debugSocket.onerror = (error) => {
                log(`❌ WebSocket 錯誤: ${error}`, 'error');
            };
        }
        
        function disconnectWS() {
            if (debugSocket) {
                debugSocket.close(1000, 'Manual disconnect');
                debugSocket = null;
            }
        }
        
        async function testSettingsUpdate() {
            try {
                log('🧪 測試設定更新...', 'info');
                const response = await fetch('/ws/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        header_interval: Math.floor(Math.random() * 10) + 3,
                        carousel_interval: Math.floor(Math.random() * 10) + 3,
                        footer_interval: Math.floor(Math.random() * 10) + 3
                    })
                });
                
                if (response.ok) {
                    log('✅ 設定更新請求成功，等待 WebSocket 通知...', 'settings');
                } else {
                    log(`❌ 設定更新失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 設定更新錯誤: ${error.message}`, 'error');
            }
        }
        
        async function testPlaylistUpdate() {
            try {
                log('🧪 測試播放列表更新...', 'info');
                const response = await fetch('/api/playlist_updated', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('✅ 播放列表更新請求成功', 'playlist');
                } else {
                    log(`❌ 播放列表更新失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 播放列表更新錯誤: ${error.message}`, 'error');
            }
        }
        
        function sendPing() {
            if (debugSocket && debugSocket.readyState === WebSocket.OPEN) {
                debugSocket.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                log('🏓 已發送 ping', 'ping');
            } else {
                log('❌ WebSocket 未連接', 'error');
            }
        }
        
        async function fetchCurrentData() {
            try {
                log('📊 獲取當前數據...', 'info');
                const response = await fetch('/api/media_with_settings');
                const data = await response.json();
                
                dataContainer.innerHTML = `
                    <strong>設定:</strong><br>
                    頁首間隔: ${data.settings?.header_interval || 'N/A'} 秒<br>
                    輪播間隔: ${data.settings?.carousel_interval || 'N/A'} 秒<br>
                    頁尾間隔: ${data.settings?.footer_interval || 'N/A'} 秒<br><br>
                    <strong>統計:</strong><br>
                    媒體數量: ${data.materials?.length || 0}<br>
                    指派數量: ${data.assignments?.length || 0}<br>
                    群組數量: ${data.groups?.length || 0}
                `;
                
                log('✅ 數據載入成功', 'info');
            } catch (error) {
                log(`❌ 數據載入失敗: ${error.message}`, 'error');
            }
        }
        
        // 頁面載入時自動連接
        document.addEventListener('DOMContentLoaded', () => {
            connectWS();
            fetchCurrentData();
        });
    </script>
</body>
</html>