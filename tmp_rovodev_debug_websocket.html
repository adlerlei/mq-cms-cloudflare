<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket äº‹ä»¶èª¿è©¦å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .log { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .button.success { background: #28a745; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.danger { background: #dc3545; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .ping { color: #28a745; font-weight: bold; }
        .pong { color: #17a2b8; font-weight: bold; }
        .settings { color: #6f42c1; font-weight: bold; }
        .playlist { color: #fd7e14; font-weight: bold; }
        .error { color: #dc3545; }
        .info { color: #007bff; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” WebSocket äº‹ä»¶èª¿è©¦å·¥å…·</h1>
        <p>æ­¤å·¥å…·ç”¨æ–¼èª¿è©¦æ¨¹è“æ´¾ display.html ä¸æœƒè‡ªå‹•åˆ·æ–°çš„å•é¡Œ</p>
        
        <div class="grid">
            <div class="section">
                <h3>ğŸ“¡ WebSocket ç‹€æ…‹</h3>
                <div id="wsStatus" class="status disconnected">æœªé€£æ¥</div>
                <button class="button" onclick="connectWS()">é€£æ¥</button>
                <button class="button danger" onclick="disconnectWS()">æ–·é–‹</button>
                <button class="button warning" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            </div>
            
            <div class="section">
                <h3>ğŸ§ª æ¸¬è©¦æ“ä½œ</h3>
                <button class="button success" onclick="testSettingsUpdate()">æ¨¡æ“¬è¨­å®šæ›´æ–°</button>
                <button class="button" onclick="testPlaylistUpdate()">æ¨¡æ“¬æ’­æ”¾åˆ—è¡¨æ›´æ–°</button>
                <button class="button warning" onclick="sendPing()">ç™¼é€ Ping</button>
                <button class="button" onclick="fetchCurrentData()">ç²å–ç•¶å‰æ•¸æ“š</button>
            </div>
        </div>
        
        <div class="section">
            <h3>ğŸ“ WebSocket äº‹ä»¶æ—¥èªŒ</h3>
            <div id="eventLog" class="log"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“Š ç•¶å‰æ•¸æ“šç‹€æ…‹</h3>
            <div id="dataStatus" class="log">å°šæœªè¼‰å…¥æ•¸æ“š</div>
        </div>
    </div>

    <script>
        let debugSocket = null;
        let logContainer = document.getElementById('eventLog');
        let dataContainer = document.getElementById('dataStatus');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logContainer.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function updateStatus(connected) {
            const statusEl = document.getElementById('wsStatus');
            if (connected) {
                statusEl.className = 'status connected';
                statusEl.textContent = 'âœ… å·²é€£æ¥';
            } else {
                statusEl.className = 'status disconnected';
                statusEl.textContent = 'âŒ å·²æ–·ç·š';
            }
        }
        
        function clearLog() {
            logContainer.innerHTML = '';
        }
        
        function connectWS() {
            if (debugSocket) {
                debugSocket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            log(`ğŸ”Œ æ­£åœ¨é€£æ¥: ${wsUrl}`, 'info');
            debugSocket = new WebSocket(wsUrl);
            
            debugSocket.onopen = () => {
                updateStatus(true);
                log('âœ… WebSocket é€£æ¥æˆåŠŸ', 'info');
            };
            
            debugSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    let logClass = 'info';
                    let emoji = 'ğŸ“¨';
                    
                    if (data.type === 'ping') {
                        logClass = 'ping';
                        emoji = 'ğŸ“';
                        // è‡ªå‹•å›æ‡‰ pong
                        debugSocket.send(JSON.stringify({ type: 'pong', timestamp: Date.now() }));
                        log('ğŸ“ å·²è‡ªå‹•å›æ‡‰ pong', 'pong');
                    } else if (data.type === 'pong') {
                        logClass = 'pong';
                        emoji = 'ğŸ“';
                    } else if (data.type === 'settings_updated') {
                        logClass = 'settings';
                        emoji = 'âš™ï¸';
                        log('ğŸ‰ é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„äº‹ä»¶ï¼è¨­å®šæ›´æ–°é€šçŸ¥ï¼', 'settings');
                    } else if (data.type === 'playlist_updated') {
                        logClass = 'playlist';
                        emoji = 'ğŸ“‹';
                    }
                    
                    log(`${emoji} æ”¶åˆ°: ${JSON.stringify(data)}`, logClass);
                } catch (error) {
                    log(`âŒ è¨Šæ¯è§£æå¤±æ•—: ${error.message}`, 'error');
                }
            };
            
            debugSocket.onclose = (event) => {
                updateStatus(false);
                log(`âŒ é€£æ¥é—œé–‰: ${event.code} - ${event.reason}`, 'error');
            };
            
            debugSocket.onerror = (error) => {
                log(`âŒ WebSocket éŒ¯èª¤: ${error}`, 'error');
            };
        }
        
        function disconnectWS() {
            if (debugSocket) {
                debugSocket.close(1000, 'Manual disconnect');
                debugSocket = null;
            }
        }
        
        async function testSettingsUpdate() {
            try {
                log('ğŸ§ª æ¸¬è©¦è¨­å®šæ›´æ–°...', 'info');
                const response = await fetch('/ws/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        header_interval: Math.floor(Math.random() * 10) + 3,
                        carousel_interval: Math.floor(Math.random() * 10) + 3,
                        footer_interval: Math.floor(Math.random() * 10) + 3
                    })
                });
                
                if (response.ok) {
                    log('âœ… è¨­å®šæ›´æ–°è«‹æ±‚æˆåŠŸï¼Œç­‰å¾… WebSocket é€šçŸ¥...', 'settings');
                } else {
                    log(`âŒ è¨­å®šæ›´æ–°å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ è¨­å®šæ›´æ–°éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        async function testPlaylistUpdate() {
            try {
                log('ğŸ§ª æ¸¬è©¦æ’­æ”¾åˆ—è¡¨æ›´æ–°...', 'info');
                const response = await fetch('/api/playlist_updated', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    log('âœ… æ’­æ”¾åˆ—è¡¨æ›´æ–°è«‹æ±‚æˆåŠŸ', 'playlist');
                } else {
                    log(`âŒ æ’­æ”¾åˆ—è¡¨æ›´æ–°å¤±æ•—: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ æ’­æ”¾åˆ—è¡¨æ›´æ–°éŒ¯èª¤: ${error.message}`, 'error');
            }
        }
        
        function sendPing() {
            if (debugSocket && debugSocket.readyState === WebSocket.OPEN) {
                debugSocket.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
                log('ğŸ“ å·²ç™¼é€ ping', 'ping');
            } else {
                log('âŒ WebSocket æœªé€£æ¥', 'error');
            }
        }
        
        async function fetchCurrentData() {
            try {
                log('ğŸ“Š ç²å–ç•¶å‰æ•¸æ“š...', 'info');
                const response = await fetch('/api/media_with_settings');
                const data = await response.json();
                
                dataContainer.innerHTML = `
                    <strong>è¨­å®š:</strong><br>
                    é é¦–é–“éš”: ${data.settings?.header_interval || 'N/A'} ç§’<br>
                    è¼ªæ’­é–“éš”: ${data.settings?.carousel_interval || 'N/A'} ç§’<br>
                    é å°¾é–“éš”: ${data.settings?.footer_interval || 'N/A'} ç§’<br><br>
                    <strong>çµ±è¨ˆ:</strong><br>
                    åª’é«”æ•¸é‡: ${data.materials?.length || 0}<br>
                    æŒ‡æ´¾æ•¸é‡: ${data.assignments?.length || 0}<br>
                    ç¾¤çµ„æ•¸é‡: ${data.groups?.length || 0}
                `;
                
                log('âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸ', 'info');
            } catch (error) {
                log(`âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£æ¥
        document.addEventListener('DOMContentLoaded', () => {
            connectWS();
            fetchCurrentData();
        });
    </script>
</body>
</html>